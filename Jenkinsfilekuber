pipeline {
  environment {
    imagename = "gcr.io/netcracker-devops/telekuber"
    registryCredential = 'my-project-gcr-credentials'
    dockerImage = ''
    project_name = "test_telebot_kubernet"
  }
  agent any
  stages {
  
    stage('Building image') {
       steps {
         script {
             sh '''
             pwd
             ls -la
             '''
             dir("code") {
                 
             dockerImage = docker.build imagename + ":$BUILD_NUMBER" 
             }
        }
      }
    }

    stage('Test') {
        steps {
            echo "Start of Stage Test"
            echo "Project name is ${project_name}"
            echo "end of Stage Test"
            sh "pwd"
            sh "ls -la"
        }
    }
    
    stage('Continuous Delivery image to GCR') {
        steps {
            script {
             docker.withRegistry( 'https://gcr.io', 'gcr:my-project-gcr-credentials') {
                dockerImage.push("$BUILD_NUMBER")
                dockerImage.push('latest')
            }
         }
     }
   }
   
   stage('Continuous Deploy / Apply  Kubernetes files') {
       steps {
            script {     
                  withKubeConfig([credentialsId: 'netcracker-devops', serverUrl: 'https://35.193.165.173']) {
                  sh '''' 
                         kubectl delete -f deployment.yaml
                         kubectl get svc
                         kubectl apply -f deployment.yaml
                         kubectl get svc
                         kubectl get deploy
                     '''
           }
        }
     }
   }
 
//   stage('Continuous Deploy') {
//       steps {
//           script {
//                   sh '''
//                          pwd
//                          ls -la
//                          kubectl get nodes
//                          kubectl get svc
//                          kubectl get deploy
//                          kubectl apply -f deployment.yaml
//                                     
//                  '''
//                   env.IS_NEW_VERSION = sh (returnStdout: true, script: "[ '${env.DEPLOY_VERSION}' ] && echo 'YES'").trim()
//           }
//       }
//   }
   
 }
}
